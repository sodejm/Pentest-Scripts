# based off: https://gist.github.com/mastahyeti/2720173
#only slight modifications

import os
import shutil
import xml.etree.ElementTree as etree

first = 1
for fileName in os.listdir("."):
    if ".nessus" in fileName:
        print(":: Parsing", fileName)
        if first:
            mainTree = etree.parse(fileName)
            report = mainTree.find('Report')
            report.attrib['name'] = 'Merged Report'
            first = 0
        else:
            tree = etree.parse(fileName)
            for host in tree.findall('.//ReportHost'):
                existing_host = report.find(".//ReportHost[@name='" + host.attrib['name'] + "']")
                if not existing_host:
                    print "adding host: " + host.attrib['name']
                    report.append(host)
                else:
                    for item in host.findall('ReportItem'):
                        if not existing_host.find("ReportItem[@port='" + item.attrib['port'] + "'][@pluginID='" +
                                                          item.attrib['pluginID'] + "']"):
                            print "adding finding: " + item.attrib['port'] + ":" + item.attrib['pluginID']
                            existing_host.append(item)
        print(":: => done.")

if "merged_nessus_report" in os.listdir("."):
    shutil.rmtree("merged_nessus_report")

os.mkdir("merged_nessus_report")
mainTree.write("merged_nessus_report/merged_report.nessus", encoding="utf-8", xml_declaration=True)
